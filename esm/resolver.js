import path$1 from"path";import sequelize from"sequelize";var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}function getCjsExportFromNamespace(e){return e&&e.default||e}var type=createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}),injector=(unwrapExports(type),createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.servInjector=void 0,t.servInjector=function(d,f,p){let e="post";for(const t in p)if(p[t].method&&d?.$inject&&d?.$inject[t]&&d?.$inject[t][f]){e=p[t].method;break}let b=null,y=null;for(const n in p)if(p[n].intercept&&d?.$inject&&d?.$inject[n]&&d?.$inject[n][f]){b=p[n].intercept,y=d?.$inject[n][f]?.option;break}return[e,async e=>{const t={};let n=null;for(const s in p)if(p[s].before&&d?.$inject&&d?.$inject[s]&&d?.$inject[s][f]){const c=p[s].before.plugin;var o=await c(e,d?.$inject[s][f]?.option);t[s]=o,p[s].before.replaceProps&&(n=o)}t.data=e.request.body,null===n&&(n=t.data);let r=null,a=(r=b?await b(d[f],[n,t,e],y):await d[f](n,t,e),!1);for(const l in p)if(p[l].after){const u=p[l].after.plugin;var i;d?.$inject&&d?.$inject[l]&&d?.$inject[l][f]&&(i=await u(r,e,d?.$inject[l][f]?.option),t[l]=i,a=!0,p[l].after.replaceProps&&(e.body=i))}a||(e.body=r)}]}})),binder=(unwrapExports(injector),injector.servInjector,createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.restfulBinder=t.routeBinder=void 0;const d=["constructor","$inject","db"];t.routeBinder=function(e,t,n){const o={};for(var r in t){var a,i=t[r],s=Object.getOwnPropertyNames(i.prototype).filter(t=>d.every(e=>t.toLowerCase()!==e)),c=Reflect.construct(i,[]);for(a of s){var[u,l]=(0,injector.servInjector)(c,a,n);e[u](`/${r}/`+a,l),o[r+"_"+a]=l}}return o},t.restfulBinder=function(e,t){const o={};for(var n in t){var n=t[n],r=Object.getOwnPropertyNames(n.prototype).filter(e=>"constructor"!==e&&"$restful"!==e);const i=Reflect.construct(n,[]);for(let n of r){const{url:s,method:c}=i.$restful[n];var a=async e=>{if("get"===c?.toLowerCase()){var t=e["params"],t=await i[n](t||{},e);e.body=t}else if("post"===c?.toLowerCase()){t=e.request.body,t=await i[n](t,e);e.body=t}else if("put"===c?.toLowerCase()){t=e.request.body,t=await i[n](t,e);e.body=t}else{if("delete"!==c?.toLowerCase())return i[n](e);t=e["params"],t=await i[n](t||{},e);e.body=t}};"get"===c?.toLowerCase()?e.get(s,a):"post"===c?.toLowerCase()?e.post(s,a):"put"===c?.toLowerCase()?e.put(s,a):"delete"===c?.toLowerCase()?e.delete(s,a):e[c](s,a),o[""+s]=a}}return o}})),factory=(unwrapExports(binder),binder.restfulBinder,binder.routeBinder,createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.injectRemove=t.injectBind=void 0,t.injectBind=function(e,t,n){e.$inject||(e.$inject={});for(const o in n)e.$inject[o]?e.$inject[o][t]=n[o]:e.$inject[o]={[t]:n[o]}},t.injectRemove=function(e,t,n){e.$inject||(e.$inject={}),e.$inject[t]&&(n?delete e.$inject[t][n]:delete e.$inject[t])}})),builder=(unwrapExports(factory),factory.injectRemove,factory.injectBind,createCommonjsModule(function(e,t){function n(s,e){const c=e?.onDecorate||(()=>""),l=e?.onBefore||((...e)=>e),u=e?.onAfter||(e=>e);return i=>(t,e,{configurable:n,enumerable:o,value:r,writable:a})=>{c(t,e,i);return(0,factory.injectBind)(t,e,{[s]:{option:i}}),{configurable:n,enumerable:o,value:async(...e)=>{e=await l(...e),e=await r.apply(t,e);return await u(e)},writable:a}}}Object.defineProperty(t,"__esModule",{value:!0}),t.propsInjectorBuilder=t.classInjectorBuilder=t.funcInjectorBuilder=t.injectorBuilder=void 0,t.injectorBuilder=n,t.funcInjectorBuilder=n,t.classInjectorBuilder=function(n,e){const o=e?.onDecorate||((...e)=>e);return t=>{return e=>(o(e,t),(0,factory.injectBind)(e,"$class",{[n]:{option:t}}),e)}},t.propsInjectorBuilder=function(r,e){const a=e?.onDecorate||((...e)=>e);return o=>{return(e,t,n)=>{a(e,t,n,o),(0,factory.injectBind)(e,"$props",{[r]:{funcName:t,option:o}})}}}})),restful=(unwrapExports(builder),builder.propsInjectorBuilder,builder.classInjectorBuilder,builder.funcInjectorBuilder,builder.injectorBuilder,createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Post=t.Get=void 0,t.Get=function(i){return(t,e,{configurable:n,enumerable:o,value:r,writable:a})=>{return t.$restful?t.$restful[e]={url:i,method:"get"}:t.$restful={[e]:{url:i,method:"get"}},{configurable:n,enumerable:o,value:async(...e)=>{return await r.apply(t,e)},writable:a}}},t.Post=function(i){return(t,e,{configurable:n,enumerable:o,value:r,writable:a})=>{return t.$restful?t.$restful[e]={url:i,method:"post"}:t.$restful={[e]:{url:i,method:"post"}},{configurable:n,enumerable:o,value:async(...e)=>{return await r.apply(t,e)},writable:a}}}}));unwrapExports(restful),restful.Post,restful.Get;const fs=require("fs"),path=require("path"),os=require("os");function log(e){console.log("[dotenv][DEBUG] "+e)}const NEWLINE="\n",RE_INI_KEY_VAL=/^\s*([\w.-]+)\s*=\s*(.*)?\s*$/,RE_NEWLINES=/\\n/g,NEWLINES_MATCH=/\r\n|\n|\r/;function parse(e,t){const a=Boolean(t&&t.debug),i={};return e.toString().split(NEWLINES_MATCH).forEach(function(e,t){var n=e.match(RE_INI_KEY_VAL);if(null!=n){var o=n[1];let e=n[2]||"";var n=e.length-1,r='"'===e[0]&&'"'===e[n];"'"===e[0]&&"'"===e[n]||r?(e=e.substring(1,n),r&&(e=e.replace(RE_NEWLINES,NEWLINE))):e=e.trim(),i[o]=e}else a&&log(`did not match key and value when parsing line ${t+1}: `+e)}),i}function resolveHome(e){return"~"===e[0]?path.join(os.homedir(),e.slice(1)):e}function config(e){let t=path.resolve(process.cwd(),".env"),n="utf8",o=!1;e&&(null!=e.path&&(t=resolveHome(e.path)),null!=e.encoding&&(n=e.encoding),null!=e.debug&&(o=!0));try{const r=parse(fs.readFileSync(t,{encoding:n}),{debug:o});return Object.keys(r).forEach(function(e){Object.prototype.hasOwnProperty.call(process.env,e)?o&&log(`"${e}" is already defined in \`process.env\` and will not be overwritten`):process.env[e]=r[e]}),{parsed:r}}catch(e){return{error:e}}}module.exports.config=config,module.exports.parse=parse;var main=Object.freeze({__proto__:null}),require$$0=getCjsExportFromNamespace(main),configurator=createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.standardTransfor=t.loadConfig=void 0,t.loadConfig=function(e){const{env:t,transfor:n}=e||{};let o="db.config.js",r={};return t&&(e=require$$0.config()["parsed"],r=e,o=`db.${r.DB_DRIVER}.js`),e=commonjsRequire(path$1.resolve(o)),n?n(e,r):e},t.standardTransfor=function(e){var t=e.driver,n=e.options;for(const o in n)if(o===t)return n[o];return[]}}),baseDefined=(unwrapExports(configurator),configurator.standardTransfor,configurator.loadConfig,createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.DefineDatabase=void 0;t.DefineDatabase=class{orm={onCallBefore:async()=>"",onCallAfter:async()=>"",onCallError:async()=>"",connect:async()=>""};options={};constructor(e,t){const n=this;this.options=t||{},this.orm=new e(t),Object.defineProperty(this.orm,"options",{get(){return n.options}}),this.database=this.database.bind(this)}async connect(...e){await this.orm?.connect(...e)}database(s){const c=this;return(r,a,{configurable:e,enumerable:t,value:i,writable:n})=>{return{configurable:e,enumerable:t,value:async(...e)=>{let t=void 0,n=void 0,o=void 0;try{n=await c.orm.onCallBefore.call(c.orm,r,a,s),t=await i.apply(r,e),o=await c.orm.onCallAfter.call(c.orm,r,a,s,n)}catch(e){throw await c.orm.onCallError.call(c.orm,r,a,s,n,o,e),e}return t},writable:n}}}}})),sequelize_loader=(unwrapExports(baseDefined),baseDefined.DefineDatabase,createCommonjsModule(function(e,c){Object.defineProperty(c,"__esModule",{value:!0}),c.baseTransfor=c.useTransaction=c.injectTransaction=c.OrmLoader=c.DefaultOptions=c.OrmSequelize=void 0;c.OrmSequelize=class{db},c.DefaultOptions={useBaseConfig:!0,useTransaction:!1,useAlwaysConnection:!1,connectionKey:"global-connection"};function n(n,o){return{create:async(e,t)=>n.create(e,{transaction:o,...t}),update:async(e,t)=>n.update(e,{transaction:o,...t}),destroy:async e=>n.destroy({transaction:o,...e}),bulkCreate:async(e,t)=>n.bulkCreate(e,{transaction:o,...t}),findAll:async e=>n.findAll({transaction:o,...e}),findOne:async e=>n.findOne({transaction:o,...e}),max:async(e,t)=>n.max(e,{transaction:o,...t}),min:async(e,t)=>n.min(e,{transaction:o,...t}),sum:async(e,t)=>n.sum(e,{transaction:o,...t}),count:async e=>n.count({transaction:o,...e})}}function u(e,t){const o=n(e,t);return new Proxy(e,{get(e,t,n){return o[t]||Reflect.get(e,t,n)}})}c.OrmLoader=class{connectionPool={};distroyConnect(e){(this.options?.useAlwaysConnection??c.DefaultOptions.useAlwaysConnection)||delete this.connectionPool[e]}options;async connect(e){var t=this.options.useBaseConfig??c.DefaultOptions.useBaseConfig,n=e?.key||c.DefaultOptions.connectionKey;this.connectionPool[n]={};try{var o=(0,configurator.loadConfig)({env:!!t,transfor:t?c.baseTransfor:configurator.standardTransfor})||[];e?.args&&0<e?.args.length?this.connectionPool[n].sequelize=new sequelize.Sequelize(...e?.args):this.connectionPool[n].sequelize=new sequelize.Sequelize(...o)}catch(e){this.distroyConnect(n)}}async onCallBefore(e,t,n){const o=this;let r=c.DefaultOptions.connectionKey,a=null;var i=this.options?.useAlwaysConnection??c.DefaultOptions.useAlwaysConnection;i||(r=Symbol(t),this.connect({key:r}));try{(n?.useTransaction??c.DefaultOptions.useTransaction)&&(a=await this.connectionPool[r].sequelize.transaction()),this.connectionPool[r].transaction=i?null:a;const s=this.declareTables(this.connectionPool[r].sequelize,a,n.tables,n.relation);return e.db=new Proxy({},{get(e,t,n){return"sequelize"===t?o.connectionPool[r].sequelize:"transaction"!==t?"tables"===t?s:Reflect.get(e,t,n):void o.connectionPool[r].transaction}}),{connectionKey:r,transaction:a}}catch(e){throw this.distroyConnect(r),e}}async onCallAfter(e,t,n,o){var r=o.connectionKey,a=this.options?.useAlwaysConnection??c.DefaultOptions.useAlwaysConnection;if((n?.useTransaction??!1)&&await o?.transaction?.commit(),!a)try{await this.connectionPool[r].sequelize.close()}catch(e){}this.distroyConnect(r)}async onCallError(e,t,n,o,r,a){var i=this.options?.useAlwaysConnection??c.DefaultOptions.useAlwaysConnection;if((n?.useTransaction??!1)&&await o?.transaction?.rollback(),!i)try{o?.connectionKey&&await this.connectionPool[o?.connectionKey].sequelize.close()}catch(e){}this.distroyConnect(o?.connectionKey)}declareTables(o,n,e,t){const r={freezeTableName:!0,timestamps:!1},a=n=>(e,t)=>o.define(n,e,{...r,...t||{}}),i=e=>{let t=null;var n=this.options.tablesStructure[e](a(e),{s:o,t:e,o:r});return t=n instanceof Array?a(e)(n[0],n[1]):n};let s={};if(e&&0<e.length)e.forEach(e=>{var t=i(e);s[e]=n?u(t,n):t}),t&&t(s);else{for(const l in this.options.tablesStructure){var c=i(l);s[l]=n?u(c,n):c}this.options?.relation&&this.options.relation(s)}return s}},c.injectTransaction=n,c.useTransaction=u;c.baseTransfor=(e,t)=>{var n={max:5,min:0,acquire:3e4,idle:1e4},t=t.DB_DRIVER;return"sqlite"===t?[{dialect:"sqlite",storage:e.path,pool:e.pool||n}]:"mysql"===t?[e.database,e.username,e.password,{host:e.host,port:e.port,dialect:"mysql",pool:e.pool||n}]:"postgres"===t?[e.database,e.username,e.password,{host:e.host,port:e.port,dialect:"postgres",pool:e.pool||n}]:[]}})),sequelize_binder=(unwrapExports(sequelize_loader),sequelize_loader.baseTransfor,sequelize_loader.useTransaction,sequelize_loader.injectTransaction,sequelize_loader.OrmLoader,sequelize_loader.DefaultOptions,sequelize_loader.OrmSequelize,createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.defineTables=void 0,t.defineTables=function(e,t,n){const o=new baseDefined.DefineDatabase(sequelize_loader.OrmLoader,{tablesStructure:e,relation:t,...n||{}});return{connect:o.connect.bind(o),Database:o.database}}})),lib=(unwrapExports(sequelize_binder),sequelize_binder.defineTables,createCommonjsModule(function(e,t){var o=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){e[o=void 0===o?n:o]=t[n]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||o(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),n(type,t),n(binder,t),n(injector,t),n(builder,t),n(factory,t),n(restful,t),n(configurator,t),n(baseDefined,t),n(sequelize_loader,t),n(sequelize_binder,t)})),index=unwrapExports(lib);export{index as default};

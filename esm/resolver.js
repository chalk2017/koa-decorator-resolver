import path$1 from"path";import sequelize from"sequelize";var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}function getCjsExportFromNamespace(e){return e&&e.default||e}var type=createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}),injector=(unwrapExports(type),createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.servInjector=void 0,t.servInjector=function(d,f,p){let e="post";for(const t in p)if(p[t].method&&d?.$inject&&d?.$inject[t]&&d?.$inject[t][f]){e=p[t].method;break}let b=null,m=null;for(const n in p)if(p[n].intercept&&d?.$inject&&d?.$inject[n]&&d?.$inject[n][f]){b=p[n].intercept,m=d?.$inject[n][f]?.option;break}return[e,async e=>{const t={};let n=null;for(const s in p)if(p[s].before&&d?.$inject&&d?.$inject[s]&&d?.$inject[s][f]){const c=p[s].before.plugin;var o=await c(e,d?.$inject[s][f]?.option);t[s]=o,p[s].before.replaceProps&&(n=o)}t.data=e.request.body,null===n&&(n=t.data);let r=null,a=(r=b?await b(d[f],[n,t,e],m):await d[f](n,t,e),!1);for(const l in p)if(p[l].after){const u=p[l].after.plugin;var i;d?.$inject&&d?.$inject[l]&&d?.$inject[l][f]&&(i=await u(r,e,d?.$inject[l][f]?.option),t[l]=i,a=!0,p[l].after.replaceProps&&(e.body=i))}a||(e.body=r)}]}})),binder=(unwrapExports(injector),injector.servInjector,createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.restfulBinder=t.routeBinder=void 0;const d=["constructor","$inject","db"];t.routeBinder=function(e,t,n){const o={};for(var r in t){var a,i=t[r],s=Object.getOwnPropertyNames(i.prototype).filter(t=>d.every(e=>t.toLowerCase()!==e)),c=Reflect.construct(i,[]);for(a of s){var[u,l]=(0,injector.servInjector)(c,a,n);e[u](`/${r}/`+a,l),o[r+"_"+a]=l}}return o},t.restfulBinder=function(e,t){const o={};for(var n in t){var n=t[n],r=Object.getOwnPropertyNames(n.prototype).filter(e=>"constructor"!==e&&"$restful"!==e);const i=Reflect.construct(n,[]);for(let n of r){const{url:s,method:c}=i.$restful[n];var a=async e=>{if("get"===c?.toLowerCase()){var t=e["params"],t=await i[n](t||{},e);e.body=t}else if("post"===c?.toLowerCase()){t=e.request.body,t=await i[n](t,e);e.body=t}else if("put"===c?.toLowerCase()){t=e.request.body,t=await i[n](t,e);e.body=t}else{if("delete"!==c?.toLowerCase())return i[n](e);t=e["params"],t=await i[n](t||{},e);e.body=t}};"get"===c?.toLowerCase()?e.get(s,a):"post"===c?.toLowerCase()?e.post(s,a):"put"===c?.toLowerCase()?e.put(s,a):"delete"===c?.toLowerCase()?e.delete(s,a):e[c](s,a),o[""+s]=a}}return o}})),factory=(unwrapExports(binder),binder.restfulBinder,binder.routeBinder,createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.injectRemove=t.injectBind=void 0,t.injectBind=function(e,t,n){e.$inject||(e.$inject={});for(const o in n)e.$inject[o]?e.$inject[o][t]=n[o]:e.$inject[o]={[t]:n[o]}},t.injectRemove=function(e,t,n){e.$inject||(e.$inject={}),e.$inject[t]&&(n?delete e.$inject[t][n]:delete e.$inject[t])}})),builder=(unwrapExports(factory),factory.injectRemove,factory.injectBind,createCommonjsModule(function(e,t){function n(s,e){const c=e?.onDecorate||(()=>""),l=e?.onBefore||((...e)=>e),u=e?.onAfter||(e=>e);return i=>{return(t,e,{configurable:n,enumerable:o,value:r,writable:a})=>{c(t,e,i);return(0,factory.injectBind)(t,e,{[s]:{option:i}}),{configurable:n,enumerable:o,value:async(...e)=>{e=await l(...e),e=await r.apply(t,e);return await u(e)},writable:a}}}}Object.defineProperty(t,"__esModule",{value:!0}),t.propsInjectorBuilder=t.classInjectorBuilder=t.funcInjectorBuilder=t.injectorBuilder=void 0,t.injectorBuilder=n,t.funcInjectorBuilder=n,t.classInjectorBuilder=function(n,e){const o=e?.onDecorate||((...e)=>e);return t=>{return e=>(o(e,t),(0,factory.injectBind)(e,"$class",{[n]:{option:t}}),e)}},t.propsInjectorBuilder=function(r,e){const a=e?.onDecorate||((...e)=>e);return o=>{return(e,t,n)=>{a(e,t,n,o),(0,factory.injectBind)(e,"$props",{[r]:{funcName:t,option:o}})}}}})),restful=(unwrapExports(builder),builder.propsInjectorBuilder,builder.classInjectorBuilder,builder.funcInjectorBuilder,builder.injectorBuilder,createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Post=t.Get=void 0,t.Get=function(i){return(t,e,{configurable:n,enumerable:o,value:r,writable:a})=>{return t.$restful?t.$restful[e]={url:i,method:"get"}:t.$restful={[e]:{url:i,method:"get"}},{configurable:n,enumerable:o,value:async(...e)=>{return await r.apply(t,e)},writable:a}}},t.Post=function(i){return(t,e,{configurable:n,enumerable:o,value:r,writable:a})=>{return t.$restful?t.$restful[e]={url:i,method:"post"}:t.$restful={[e]:{url:i,method:"post"}},{configurable:n,enumerable:o,value:async(...e)=>{return await r.apply(t,e)},writable:a}}}}));unwrapExports(restful),restful.Post,restful.Get;const fs=require("fs"),path=require("path"),os=require("os");function log(e){console.log("[dotenv][DEBUG] "+e)}const NEWLINE="\n",RE_INI_KEY_VAL=/^\s*([\w.-]+)\s*=\s*(.*)?\s*$/,RE_NEWLINES=/\\n/g,NEWLINES_MATCH=/\r\n|\n|\r/;function parse(e,t){const a=Boolean(t&&t.debug),i={};return e.toString().split(NEWLINES_MATCH).forEach(function(e,t){var n=e.match(RE_INI_KEY_VAL);if(null!=n){var o=n[1];let e=n[2]||"";var n=e.length-1,r='"'===e[0]&&'"'===e[n];"'"===e[0]&&"'"===e[n]||r?(e=e.substring(1,n),r&&(e=e.replace(RE_NEWLINES,NEWLINE))):e=e.trim(),i[o]=e}else a&&log(`did not match key and value when parsing line ${t+1}: `+e)}),i}function resolveHome(e){return"~"===e[0]?path.join(os.homedir(),e.slice(1)):e}function config(e){let t=path.resolve(process.cwd(),".env"),n="utf8",o=!1;e&&(null!=e.path&&(t=resolveHome(e.path)),null!=e.encoding&&(n=e.encoding),null!=e.debug&&(o=!0));try{const r=parse(fs.readFileSync(t,{encoding:n}),{debug:o});return Object.keys(r).forEach(function(e){Object.prototype.hasOwnProperty.call(process.env,e)?o&&log(`"${e}" is already defined in \`process.env\` and will not be overwritten`):process.env[e]=r[e]}),{parsed:r}}catch(e){return{error:e}}}module.exports.config=config,module.exports.parse=parse;var main=Object.freeze({__proto__:null}),require$$0=getCjsExportFromNamespace(main),configurator=createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.standardTransfor=t.loadConfig=void 0,t.loadConfig=function(e){const{env:t,transfor:n}=e||{};let o="db.config.js",r={};return t&&(e=require$$0.config()["parsed"],r=e,o=`db.${r.DB_DRIVER}.js`),e=commonjsRequire(path$1.resolve(o)),n?n(e,r):e},t.standardTransfor=function(e){var t=e.driver,n=e.options;for(const o in n)if(o===t)return n[o];return[]}}),baseDefined=(unwrapExports(configurator),configurator.standardTransfor,configurator.loadConfig,createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.DefineDatabase=void 0;t.DefineDatabase=class{orm={onCallBefore:async()=>"",onCallAfter:async()=>"",onCallError:async()=>"",connect:async()=>""};options={};constructor(e,t){this.options=t||{},this.orm=new e(t),Object.defineProperty(this.orm,"options",{get(){return this.options}})}async connect(...e){await this.orm?.connect(...e)}database(i){const s=this;return(n,o,{configurable:e,enumerable:t,value:r,writable:a})=>{return{configurable:e,enumerable:t,value:async(...e)=>{let t=void 0;try{await s.orm.onCallBefore.call(s.orm,n,o,i),t=await r.apply(n,e),await s.orm.onCallAfter.call(s.orm,n,o,i)}catch(e){throw await s.orm.onCallError.call(s.orm,n,o,i,e),e}return t},writable:a}}}}})),sequelize_loader=(unwrapExports(baseDefined),baseDefined.DefineDatabase,createCommonjsModule(function(e,a){Object.defineProperty(a,"__esModule",{value:!0}),a.baseTransfor=a.useTransaction=a.injectTransaction=a.OrmLoader=a.DefaultOptions=a.OrmSequelize=void 0;a.OrmSequelize=class{db},a.DefaultOptions={useBaseConfig:!0,useTransaction:!1,useAlwaysConnection:!1};function n(n,o){return{create:async(e,t)=>n.create(e,{transaction:o,...t}),update:async(e,t)=>n.update(e,{transaction:o,...t}),destroy:async e=>n.destroy({transaction:o,...e}),bulkCreate:async(e,t)=>n.bulkCreate(e,{transaction:o,...t}),findAll:async e=>n.findAll({transaction:o,...e}),findOne:async e=>n.findOne({transaction:o,...e}),max:async(e,t)=>n.max(e,{transaction:o,...t}),min:async(e,t)=>n.min(e,{transaction:o,...t}),sum:async(e,t)=>n.sum(e,{transaction:o,...t}),count:async e=>n.count({transaction:o,...e})}}function u(e,t){const o=n(e,t);return new Proxy(e,{get(e,t,n){return o[t]||Reflect.get(e,t,n)}})}a.OrmLoader=class{db={sequelize:void 0,transaction:void 0,tables:void 0};options;async connect(...e){var t=this.options.useBaseConfig??a.DefaultOptions.useBaseConfig;try{var n=(0,configurator.loadConfig)({env:!!t,transfor:t?a.baseTransfor:configurator.standardTransfor})||[];e&&0<e.length?this.db.sequelize=new sequelize.Sequelize(...e):this.db.sequelize=new sequelize.Sequelize(...n)}catch(e){}}async onCallBefore(e,t,n){(this.options?.useAlwaysConnection??a.DefaultOptions.useAlwaysConnection)||this.connect();var o=n?.useTransaction??a.DefaultOptions.useTransaction;o&&(this.db.transaction=await this.db.sequelize.transaction()),this.db.tables=this.declareTables(this.db.sequelize,this.db.transaction,n.tables,n.relation),e.db=this.db}async onCallAfter(e,t,n){var o=this.options?.useAlwaysConnection??a.DefaultOptions.useAlwaysConnection;if((n?.useTransaction??!1)&&await this.db.transaction.commit(),!o)try{await this.db.sequelize.close()}catch(e){}}async onCallError(e,t,n,o){var r=this.options?.useAlwaysConnection??a.DefaultOptions.useAlwaysConnection;if((n?.useTransaction??!1)&&await this.db.transaction.rollback(),!r)try{await this.db.sequelize.close()}catch(e){}}declareTables(o,n,e,t){const r={freezeTableName:!0,timestamps:!1},a=n=>(e,t)=>o.define(n,e,{...r,...t||{}}),i=e=>{let t=null;var n=this.options.tablesStructure[e](a(e),{s:o,t:e,o:r});return t=n instanceof Array?a(e)(n[0],n[1]):n};let s={};if(e&&0<e.length)e.forEach(e=>{var t=i(e);s[e]=n?u(t,n):t}),t&&t(s);else{for(const l in this.options.tablesStructure){var c=i(l);s[l]=n?u(c,n):c}this.options?.relation&&this.options.relation(s)}return s}},a.injectTransaction=n,a.useTransaction=u;a.baseTransfor=(e,t)=>{t=t.DB_DRIVER;return"sqlite"===t?[{dialect:"sqlite",storage:e.path}]:"mysql"===t?[e.database,e.username,e.password,{host:e.host,port:e.port,dialect:"mysql"}]:"postgres"===t?[e.database,e.username,e.password,{host:e.host,port:e.port,dialect:"postgres"}]:[]}})),sequelize_binder=(unwrapExports(sequelize_loader),sequelize_loader.baseTransfor,sequelize_loader.useTransaction,sequelize_loader.injectTransaction,sequelize_loader.OrmLoader,sequelize_loader.DefaultOptions,sequelize_loader.OrmSequelize,createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.defineTables=void 0,t.defineTables=function(e,t,n){return{connect:(e=new baseDefined.DefineDatabase(sequelize_loader.OrmLoader,{tablesStructure:e,relation:t,...n||{}})).connect,Database:e.database}}})),lib=(unwrapExports(sequelize_binder),sequelize_binder.defineTables,createCommonjsModule(function(e,t){var o=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){e[o=void 0===o?n:o]=t[n]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||o(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),n(type,t),n(binder,t),n(injector,t),n(builder,t),n(factory,t),n(restful,t),n(configurator,t),n(baseDefined,t),n(sequelize_loader,t),n(sequelize_binder,t)})),index=unwrapExports(lib);export{index as default};
